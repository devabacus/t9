
import 'package:flutter_riverpod/flutter_riverpod.dart';
import 'package:riverpod_annotation/riverpod_annotation.dart';

part 'sync_registry.g.dart';

/// –ê–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è –ª—é–±–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω.
/// –õ—é–±–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π, —Ä–µ–∞–ª–∏–∑—É—é—â–∏–π —ç—Ç–æ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ SyncRegistry.
abstract class ISyncableRepository {
  /// –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (pull, reconcile, push).
  Future<void> syncWithServer();

  /// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ real-time —Å–æ–±—ã—Ç–∏—è —Å —Å–µ—Ä–≤–µ—Ä–∞.
  void initEventBasedSync();

  /// –û—Å–≤–æ–±–æ–∂–¥–∞–µ—Ç —Ä–µ—Å—É—Ä—Å—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ—Ç–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –æ—Ç —Å—Ç—Ä–∏–º–æ–≤).
  void dispose();

  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
  String get entityTypeName;
}

/// –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º—ã–º–∏ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º–∏.
class SyncRegistry {
  final Map<String, ISyncableRepository> _repositories = {};

  /// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —Ä–µ–µ—Å—Ç—Ä–µ.
  void registerRepository(String key, ISyncableRepository repository) {
    print('‚úÖ –†–µ–µ—Å—Ç—Ä: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å –∫–ª—é—á–æ–º "$key"');
    _repositories[key] = repository;
  }

  /// –£–¥–∞–ª—è–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏–∑ —Ä–µ–µ—Å—Ç—Ä–∞.
  /// –û–±—ã—á–Ω–æ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
  void unregisterRepository(String key) {
    print('üõë –†–µ–µ—Å—Ç—Ä: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –¥–ª—è –∫–ª—é—á–∞ "$key" —Å–Ω—è—Ç–∞');
    _repositories.remove(key);
  }

  /// –ó–∞–ø—É—Å–∫–∞–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.
  Future<void> syncAll() async {
    print('üîÑ –†–µ–µ—Å—Ç—Ä: –ó–∞–ø—É—Å–∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è –≤—Å–µ—Ö ${_repositories.length} —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤...');
    for (final repository in _repositories.values) {
      try {
        // –ú—ã –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º initEventBasedSync –∑–¥–µ—Å—å, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è
        // –≤–Ω—É—Ç—Ä–∏ syncWithServer –∏–ª–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∞–º–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
        await repository.syncWithServer();
      } catch (e) {
        print(
            '‚ùå –†–µ–µ—Å—Ç—Ä: –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è "${repository.entityTypeName}": $e');
      }
    }
  }

  /// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤.
  List<ISyncableRepository> get repositories => _repositories.values.toList();
}

/// –ü—Ä–æ–≤–∞–π–¥–µ—Ä –¥–ª—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–∞ —Ä–µ–µ—Å—Ç—Ä–∞ –Ω–∞ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.
@Riverpod(keepAlive: true)
SyncRegistry syncRegistry(Ref ref) {
  return SyncRegistry();
}
